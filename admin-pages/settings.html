<div class="tab-content-wrapper">
    <div class="section-card">
        <div class="section-header">
            <h5><i class="fas fa-eye me-2"></i>Hi·ªÉn th·ªã c√°c ph·∫ßn</h5>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showGallery" checked>
                        <label class="form-check-label" for="showGallery">
                            Hi·ªÉn th·ªã th∆∞ vi·ªán ·∫£nh
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showStory" checked>
                        <label class="form-check-label" for="showStory">
                            Hi·ªÉn th·ªã c√¢u chuy·ªán
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showCouple" checked>
                        <label class="form-check-label" for="showCouple">
                            Hi·ªÉn th·ªã th√¥ng tin c·∫∑p ƒë√¥i
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showRSVP" checked>
                        <label class="form-check-label" for="showRSVP">
                            Hi·ªÉn th·ªã ph·∫ßn x√°c nh·∫≠n tham d·ª±
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showDonate" checked>
                        <label class="form-check-label" for="showDonate">
                            Hi·ªÉn th·ªã ph·∫ßn ch√∫c m·ª´ng
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showAudio" checked>
                        <label class="form-check-label" for="showAudio">
                            Ph√°t nh·∫°c n·ªÅn
                        </label>
                    </div>
                </div>
            </div>
            <div class="section-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        <small><i class="fas fa-info-circle me-1"></i>Thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u sau 0.5 gi√¢y</small>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveSettingsChanges()">
                        <i class="fas fa-save me-2"></i>L∆∞u l·∫°i
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>// Settings Tab JavaScript
function initializeSettings() {
    console.log("Initializing settings tab");
    
    // Load settings data
    loadSettingsData();
    
    // Setup event listeners
    setupSettingsEventListeners();
}

function loadSettingsData() {
    if (window.siteData  window.siteData.visibility?.sections) {
        const sections = window.siteData.visibility.sections;
        
        // Update form fields
        setFieldValue("showGallery", sections.gallery);
        setFieldValue("showStory", sections.story);
        setFieldValue("showCouple", sections.couple);
        setFieldValue("showRSVP", sections.rsvp);
        setFieldValue("showDonate", sections.donate);
        setFieldValue("showAudio", sections.audio);
    }
}

function setupSettingsEventListeners() {
    // Form field listeners
    const settingsFields = ["showGallery", "showStory", "showCouple", "showRSVP", "showDonate", "showAudio"];
    
    settingsFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener("change", function() {
                updateSiteDataFromSettingsForm();
                
                // Trigger auto-save via updateSiteData
                const sectionKey = fieldId.replace('show', '').toLowerCase();
                if (sectionKey === 'rsvp') {
                    // Also update invitation section
                    if (typeof updateSiteData === 'function') {
                        updateSiteData('visibility.sections.rsvp', this.checked);
                    }
                } else if (sectionKey === 'audio') {
                    if (typeof updateSiteData === 'function') {
                        updateSiteData('visibility.sections.audio', this.checked);
                    }
                } else {
                    if (typeof updateSiteData === 'function') {
                        updateSiteData(`visibility.sections.${sectionKey}`, this.checked);
                    }
                }
            });
        }
    });
}

function updateSiteDataFromSettingsForm() {
    if (!window.siteData) window.siteData = {};
    if (!window.siteData.visibility) window.siteData.visibility = {};
    if (!window.siteData.visibility.sections) window.siteData.visibility.sections = {};
    
    // Update visibility settings
    window.siteData.visibility.sections.gallery = document.getElementById("showGallery")?.checked || false;
    window.siteData.visibility.sections.story = document.getElementById("showStory")?.checked || false;
    window.siteData.visibility.sections.couple = document.getElementById("showCouple")?.checked || false;
    window.siteData.visibility.sections.rsvp = document.getElementById("showRSVP")?.checked || false;
    window.siteData.visibility.sections.donate = document.getElementById("showDonate")?.checked || false;
    window.siteData.visibility.sections.audio = document.getElementById("showAudio")?.checked || false;
    
    // Update last modified
    if (!window.siteData.admin) window.siteData.admin = {};
    window.siteData.admin.lastUpdate = new Date().toISOString();
}

function setFieldValue(fieldId, value) {
    const field = document.getElementById(fieldId);
    if (field  value !== undefined) {
        if (field.type === "checkbox") {
            field.checked = !!value;
        } else {
            field.value = value;
        }
    }
}

// Save settings changes (only visibility)
async function saveSettingsChanges() {
    console.log('üíæ saveSettingsChanges called');
    
    // Update form data first
    updateSiteDataFromSettingsForm();
    
    // Ensure window.siteData exists
    if (!window.siteData) {
        console.log('‚ö†Ô∏è window.siteData not found, creating...');
        window.siteData = {};
    }
    if (!window.siteData.visibility) {
        window.siteData.visibility = {};
    }
    if (!window.siteData.visibility.sections) {
        window.siteData.visibility.sections = {};
    }
    
    console.log('üíæ Visibility data to save:', window.siteData.visibility);
    
    // Save directly via API (more reliable)
    try {
        const visibilityData = {
            visibility: window.siteData.visibility,
            admin: window.siteData.admin || { lastUpdate: new Date().toISOString() }
        };
        
        if (!visibilityData.admin.lastUpdate) {
            visibilityData.admin.lastUpdate = new Date().toISOString();
        }
        
        console.log('üíæ Sending to API:', visibilityData);
        
        const response = await fetch(window.location.origin + '/api/data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(visibilityData)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Visibility settings saved:', result);
            if (typeof showAlert === 'function') {
                showAlert('ƒê√£ l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã', 'success');
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: 'ƒê√£ l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } else {
            const errorText = await response.text();
            console.error('‚ùå API save failed:', response.status, errorText);
            throw new Error(`API error: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Error saving visibility settings:', error);
        if (typeof showAlert === 'function') {
            showAlert('L·ªói khi l∆∞u c√†i ƒë·∫∑t: ' + error.message, 'error');
        } else if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: 'Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t: ' + error.message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
            });
        }
    }
}

// Export functions for global access
window.initializeSettings = initializeSettings;
window.saveSettingsChanges = saveSettingsChanges;
</script>
