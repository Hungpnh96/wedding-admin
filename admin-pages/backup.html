<div class="tab-content-wrapper">
    <div class="section-card">
        <div class="section-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-database me-2"></i>Qu·∫£n l√Ω Backup Database</h5>
            <div>
                <button class="btn btn-info btn-sm me-2" onclick="refreshBackupStats()">
                    <i class="fas fa-sync me-1"></i>L√†m m·ªõi
                </button>
                <button class="btn btn-warning btn-sm" onclick="cleanupBackups()">
                    <i class="fas fa-trash me-1"></i>D·ªçn d·∫πp
                </button>
            </div>
        </div>
        <div class="section-body">
            <!-- Backup Stats -->
            <div id="backupStats" class="mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalBackups">-</h3>
                                <p>T·ªïng backup</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalSize">-</h3>
                                <p>Dung l∆∞·ª£ng</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="maxBackups">5</h3>
                                <p>Gi·ªõi h·∫°n</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="lastBackup">-</h3>
                                <p>Backup m·ªõi nh·∫•t</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Backups -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Backup g·∫ßn ƒë√¢y
                    </h6>
                </div>
                <div class="card-body">
                    <div id="backupList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Thao t√°c
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success w-100 mb-2" onclick="createBackup()">
                                <i class="fas fa-plus me-2"></i>T·∫°o backup m·ªõi
                            </button>
                            <button class="btn btn-info w-100" onclick="refreshBackupStats()">
                                <i class="fas fa-sync me-2"></i>L√†m m·ªõi th·ªëng k√™
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-warning w-100 mb-2" onclick="cleanupBackups()">
                                <i class="fas fa-trash me-2"></i>D·ªçn d·∫πp backup c≈©
                            </button>
                            <button class="btn btn-secondary w-100" onclick="exportBackupList()">
                                <i class="fas fa-download me-2"></i>Xu·∫•t danh s√°ch
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="alert alert-info mt-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Th√¥ng tin:</strong> H·ªá th·ªëng t·ª± ƒë·ªông gi·ªØ l·∫°i 5 backup m·ªõi nh·∫•t. 
                Backup c≈© s·∫Ω ƒë∆∞·ª£c x√≥a t·ª± ƒë·ªông khi t·∫°o backup m·ªõi.
            </div>
        </div>
    </div>
</div>

<script>
// Backup management functions
let backupStats = null;

// Initialize backup page
function initializeBackup() {
    console.log('üöÄ Initializing backup page');
    refreshBackupStats();
}

// Load backup stats
async function refreshBackupStats() {
    try {
        console.log('üìä Loading backup stats...');
        
        const response = await fetch(window.location.origin + '/api/backup/stats');
        const result = await response.json();
        
        if (result.success) {
            backupStats = result.data;
            displayBackupStats();
            displayBackupList();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading backup stats:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ backup: ' + error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Display backup stats
function displayBackupStats() {
    if (!backupStats) return;
    
    document.getElementById('totalBackups').textContent = backupStats.total_backups;
    document.getElementById('totalSize').textContent = formatFileSize(backupStats.total_size);
    document.getElementById('maxBackups').textContent = backupStats.max_backups;
    
    if (backupStats.recent_backups.length > 0) {
        const lastBackup = backupStats.recent_backups[0];
        document.getElementById('lastBackup').textContent = formatDate(lastBackup.created);
    } else {
        document.getElementById('lastBackup').textContent = 'Ch∆∞a c√≥';
    }
}

// Display backup list
function displayBackupList() {
    const backupList = document.getElementById('backupList');
    if (!backupStats || !backupStats.recent_backups) {
        backupList.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ backup n√†o</p>';
        return;
    }
    
    if (backupStats.recent_backups.length === 0) {
        backupList.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ backup n√†o</p>';
        return;
    }
    
    backupList.innerHTML = backupStats.recent_backups.map((backup, index) => `
        <div class="backup-item ${index === 0 ? 'latest' : ''}">
            <div class="backup-info">
                <div class="backup-name">
                    <i class="fas fa-database me-2"></i>
                    ${backup.filename}
                    ${index === 0 ? '<span class="badge bg-success ms-2">M·ªõi nh·∫•t</span>' : ''}
                </div>
                <div class="backup-details">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>${formatDate(backup.created)}
                        <span class="mx-2">‚Ä¢</span>
                        <i class="fas fa-hdd me-1"></i>${formatFileSize(backup.size)}
                    </small>
                </div>
            </div>
            <div class="backup-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="restoreBackup('${backup.filename}')" title="Kh√¥i ph·ª•c">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="downloadBackup('${backup.filename}')" title="T·∫£i v·ªÅ">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Create new backup
async function createBackup() {
    try {
        Swal.fire({
            title: 'T·∫°o backup m·ªõi',
            text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·∫°o backup m·ªõi?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'T·∫°o backup',
            cancelButtonText: 'H·ªßy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'ƒêang t·∫°o backup...',
                    text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Trigger backup by saving data
                const response = await fetch(window.location.origin + '/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trigger_backup: true })
                });
                
                if (response.ok) {
                    Swal.close();
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng!',
                        text: 'Backup ƒë√£ ƒë∆∞·ª£c t·∫°o',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    
                    // Refresh stats
                    setTimeout(refreshBackupStats, 1000);
                } else {
                    throw new Error('Failed to create backup');
                }
            }
        });
    } catch (error) {
        console.error('Error creating backup:', error);
        Swal.close();
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'Kh√¥ng th·ªÉ t·∫°o backup: ' + error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Cleanup old backups
async function cleanupBackups() {
    try {
        const result = await Swal.fire({
            title: 'D·ªçn d·∫πp backup',
            text: 'X√≥a c√°c backup c≈©, ch·ªâ gi·ªØ l·∫°i 5 b·∫£n m·ªõi nh·∫•t?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'D·ªçn d·∫πp',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#d33'
        });
        
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'ƒêang d·ªçn d·∫πp...',
                text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const response = await fetch(window.location.origin + '/api/backup/cleanup', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            Swal.close();
            
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Refresh stats
                setTimeout(refreshBackupStats, 1000);
            } else {
                throw new Error(result.message);
            }
        }
    } catch (error) {
        console.error('Error cleaning up backups:', error);
        Swal.close();
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'Kh√¥ng th·ªÉ d·ªçn d·∫πp backup: ' + error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Restore backup
async function restoreBackup(filename) {
    try {
        const result = await Swal.fire({
            title: 'Kh√¥i ph·ª•c backup',
            text: `Kh√¥i ph·ª•c t·ª´ backup "${filename}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Kh√¥i ph·ª•c',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#d33'
        });
        
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'ƒêang kh√¥i ph·ª•c...',
                text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const response = await fetch(`${window.location.origin}/api/backup/restore/${filename}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            Swal.close();
            
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Refresh stats
                setTimeout(refreshBackupStats, 1000);
            } else {
                throw new Error(result.message);
            }
        }
    } catch (error) {
        console.error('Error restoring backup:', error);
        Swal.close();
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'Kh√¥ng th·ªÉ kh√¥i ph·ª•c backup: ' + error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Download backup
function downloadBackup(filename) {
    // This would need to be implemented on the server side
    Swal.fire({
        icon: 'info',
        title: 'T√≠nh nƒÉng s·∫Øp c√≥',
        text: 'T√≠nh nƒÉng t·∫£i backup s·∫Ω ƒë∆∞·ª£c th√™m trong phi√™n b·∫£n ti·∫øp theo',
        confirmButtonText: 'OK'
    });
}

// Export backup list
function exportBackupList() {
    if (!backupStats || !backupStats.recent_backups) {
        Swal.fire({
            icon: 'warning',
            title: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
            text: 'Kh√¥ng c√≥ backup n√†o ƒë·ªÉ xu·∫•t',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    const data = {
        total_backups: backupStats.total_backups,
        total_size: backupStats.total_size,
        max_backups: backupStats.max_backups,
        recent_backups: backupStats.recent_backups
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-list-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    Swal.fire({
        icon: 'success',
        title: 'Th√†nh c√¥ng!',
        text: 'Danh s√°ch backup ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ',
        timer: 1500,
        showConfirmButton: false
    });
}

// Helper functions
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('vi-VN');
}

// Export functions
window.initializeBackup = initializeBackup;
window.refreshBackupStats = refreshBackupStats;
window.createBackup = createBackup;
window.cleanupBackups = cleanupBackups;
window.restoreBackup = restoreBackup;
window.downloadBackup = downloadBackup;
window.exportBackupList = exportBackupList;

// Auto-initialize
document.addEventListener('DOMContentLoaded', initializeBackup);
</script>

<style>
/* Backup page styles */
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 24px;
    color: white;
}

.stat-card:nth-child(1) .stat-icon { background: #28a745; }
.stat-card:nth-child(2) .stat-icon { background: #17a2b8; }
.stat-card:nth-child(3) .stat-icon { background: #ffc107; }
.stat-card:nth-child(4) .stat-icon { background: #6c757d; }

.stat-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: #2c3e50;
}

.stat-content p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.backup-item:hover {
    border-color: #9f5958;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.backup-item.latest {
    border-color: #28a745;
    background: #f8fff9;
}

.backup-info {
    flex: 1;
}

.backup-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.backup-details {
    color: #6c757d;
    font-size: 14px;
}

.backup-actions {
    display: flex;
    gap: 8px;
}

.backup-actions .btn {
    padding: 6px 12px;
    font-size: 12px;
}

@media (max-width: 768px) {
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        margin-right: 0;
        margin-bottom: 10px;
    }
    
    .backup-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .backup-actions {
        margin-top: 10px;
        width: 100%;
        justify-content: flex-end;
    }
}
</style>


