<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Chuyển Khoản - Wedding Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .payment-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .qr-preview {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .payment-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .payment-item.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .btn-add-payment {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
        }
        .btn-add-payment:hover {
            background: linear-gradient(45deg, #218838, #1ea085);
            color: white;
        }
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
            <div class="row">
            <!-- Main content -->
            <main class="col-md ms-sm-auto col-lg-12">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-credit-card text-success"></i> Quản Lý Chuyển Khoản
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-add-payment" onclick="showAddPaymentModal()">
                            <i class="fas fa-plus"></i> Thêm Thông Tin Chuyển Khoản
                        </button>
                    </div>
                </div>

                <!-- Global Message Section -->
                <div class="payment-card mb-4">
                    <h4><i class="fas fa-comment-dots me-2"></i>Thông Điệp Chung</h4>
                    <div class="mb-3">
                        <label for="globalMessage" class="form-label">Lời nhắn cho khách mời</label>
                        <textarea class="form-control" id="globalMessage" rows="3" placeholder="Nhập lời nhắn chung cho khách mời..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveGlobalMessage()">
                        <i class="fas fa-save"></i> Lưu Thông Điệp
                    </button>
                </div>

                <!-- Payment Information List -->
                <div class="payment-card">
                    <h4><i class="fas fa-list me-2"></i>Danh Sách Thông Tin Chuyển Khoản</h4>
                    <div id="paymentList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                            <p class="mt-2">Đang tải thông tin chuyển khoản...</p>
                        </div>
                    </div>
                </div>
            </main>
                        </div>
                    </div>

    <!-- Add/Edit Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">
                        <i class="fas fa-plus"></i> Thêm Thông Tin Chuyển Khoản
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId" value="">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="recipientName" class="form-label">Tên người nhận <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="recipientName" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bankName" class="form-label">Tên ngân hàng <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bankName" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="accountNumber" class="form-label">Số tài khoản <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="accountNumber" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="title" class="form-label">Tiêu đề hiển thị</label>
                                    <input type="text" class="form-control" id="title" placeholder="VD: Mừng cưới đến chú rể">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Mô tả thêm</label>
                                    <textarea class="form-control" id="description" rows="2" placeholder="Mô tả thêm về thông tin chuyển khoản..."></textarea>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="qrCodeFile" class="form-label">QR Code</label>
                                    <input type="file" class="form-control" id="qrCodeFile" accept="image/*" onchange="previewQRCode(this)">
                                    <div class="form-text">Chọn file ảnh QR code (PNG, JPG, WEBP)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">QR Code Preview</label>
                                    <div class="qr-code-container">
                                        <div id="qrPreview">
                                            <i class="fas fa-qrcode fa-3x text-muted"></i>
                                            <p class="text-muted mt-2">Chưa có QR code</p>
                        </div>
                    </div>
                </div>
                                
                                <div class="mb-3">
                                    <label for="isActive" class="form-label">Trạng thái</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                                        <label class="form-check-label" for="isActive">
                                            Hiển thị trên trang chủ
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="sortOrder" class="form-label">Thứ tự hiển thị</label>
                                    <input type="number" class="form-control" id="sortOrder" value="1" min="1">
                    </div>
                </div>
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="savePayment()">
                        <i class="fas fa-save"></i> Lưu Thông Tin
                    </button>
            </div>
        </div>
    </div>
</div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let payments = [];
        let globalMessage = '';

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPayments();
            loadGlobalMessage();
        });

        // Load payments from API
        async function loadPayments() {
            try {
                const response = await fetch('window.location.origin/api/payment/list');
                const data = await response.json();

                if (data.success) {
                    payments = data.data;
                    renderPayments();
                } else {
                    showError('Không thể tải danh sách chuyển khoản: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                showError('Có lỗi xảy ra khi tải danh sách chuyển khoản');
            }
        }

        // Load global message
        async function loadGlobalMessage() {
            try {
                const response = await fetch('window.location.origin/api/payment/global-message');
                const data = await response.json();

                if (data.success) {
                    globalMessage = data.data.message || '';
                    document.getElementById('globalMessage').value = globalMessage;
                }
            } catch (error) {
                console.error('Error loading global message:', error);
            }
        }

        // Render payments list
        function renderPayments() {
            const container = document.getElementById('paymentList');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Chưa có thông tin chuyển khoản</h5>
                        <p class="text-muted">Hãy thêm thông tin chuyển khoản đầu tiên</p>
                    </div>
                `;
                return;
            }

            let html = '';
            payments.forEach((payment, index) => {
                html += `
                    <div class="payment-item" data-id="${payment.id}">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="payment-info">
                                    <h6 class="mb-2">
                                        <i class="fas fa-user me-2"></i>${payment.title || payment.recipient_name}
                                        ${payment.is_active ? '<span class="badge bg-success ms-2">Đang hiển thị</span>' : '<span class="badge bg-secondary ms-2">Ẩn</span>'}
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Ngân hàng:</strong> ${payment.bank_name}</p>
                                            <p class="mb-1"><strong>Tên:</strong> ${payment.recipient_name}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>STK:</strong> ${payment.account_number}</p>
                                            <p class="mb-1"><strong>Thứ tự:</strong> ${payment.sort_order}</p>
                                        </div>
                                    </div>
                                    ${payment.description ? `<p class="mb-0 text-muted"><small>${payment.description}</small></p>` : ''}
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="qr-code-container">
                                    ${payment.qr_code_url ? 
                                        `<img src="${payment.qr_code_url}" alt="QR Code" class="img-fluid" style="max-width: 80px;">` :
                                        `<i class="fas fa-qrcode text-muted"></i>`
                                    }
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="editPayment(${payment.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show add payment modal
        function showAddPaymentModal() {
            document.getElementById('paymentModalTitle').innerHTML = '<i class="fas fa-plus"></i> Thêm Thông Tin Chuyển Khoản';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
            document.getElementById('qrPreview').innerHTML = `
                <i class="fas fa-qrcode fa-3x text-muted"></i>
                <p class="text-muted mt-2">Chưa có QR code</p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        // Edit payment
        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;

            document.getElementById('paymentModalTitle').innerHTML = '<i class="fas fa-edit"></i> Chỉnh Sửa Thông Tin Chuyển Khoản';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('recipientName').value = payment.recipient_name;
            document.getElementById('bankName').value = payment.bank_name;
            document.getElementById('accountNumber').value = payment.account_number;
            document.getElementById('title').value = payment.title || '';
            document.getElementById('description').value = payment.description || '';
            document.getElementById('isActive').checked = payment.is_active;
            document.getElementById('sortOrder').value = payment.sort_order;

            // Show QR code preview
            if (payment.qr_code_url) {
                document.getElementById('qrPreview').innerHTML = `
                    <img src="${payment.qr_code_url}" alt="QR Code" class="img-fluid" style="max-width: 150px;">
                `;
            }

            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        // Save payment
        async function savePayment() {
            const form = document.getElementById('paymentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const paymentId = document.getElementById('paymentId').value || null;
            const qrFile = document.getElementById('qrCodeFile').files[0];
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('recipient_name', document.getElementById('recipientName').value);
            formData.append('bank_name', document.getElementById('bankName').value);
            formData.append('account_number', document.getElementById('accountNumber').value);
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('is_active', document.getElementById('isActive').checked);
            formData.append('sort_order', parseInt(document.getElementById('sortOrder').value));
            
            if (qrFile) {
                formData.append('qr_code_file', qrFile);
            }

            try {
                const url = paymentId ? 
                    `window.location.origin/api/payment/${paymentId}` : 
                    'window.location.origin/api/payment';
                
                const method = paymentId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: paymentId ? 'Thông tin chuyển khoản đã được cập nhật' : 'Thông tin chuyển khoản đã được thêm'
                    });
                    
                    // Close modal and reload data
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    loadPayments();
                } else {
                    showError('Không thể lưu thông tin: ' + data.message);
                }
            } catch (error) {
                console.error('Error saving payment:', error);
                showError('Có lỗi xảy ra khi lưu thông tin');
            }
        }

        // Delete payment
        async function deletePayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;

            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: `Bạn có chắc chắn muốn xóa thông tin chuyển khoản "${payment.title || payment.recipient_name}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`window.location.origin/api/payment/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Đã xóa!',
                            text: 'Thông tin chuyển khoản đã được xóa'
                        });
                        loadPayments();
        } else {
                        showError('Không thể xóa: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error deleting payment:', error);
                    showError('Có lỗi xảy ra khi xóa thông tin');
                }
            }
        }

        // Save global message
        async function saveGlobalMessage() {
            const message = document.getElementById('globalMessage').value;

            try {
                const response = await fetch('window.location.origin/api/payment/global-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Thông điệp chung đã được lưu'
                    });
                    globalMessage = message;
                } else {
                    showError('Không thể lưu thông điệp: ' + data.message);
                }
            } catch (error) {
                console.error('Error saving global message:', error);
                showError('Có lỗi xảy ra khi lưu thông điệp');
            }
        }

        // Show error
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: message
            });
        }

        // Preview QR code when file is selected
        function previewQRCode(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('qrPreview').innerHTML = `
                        <img src="${e.target.result}" alt="QR Code Preview" class="img-fluid" style="max-width: 150px;">
                        <p class="text-muted mt-2"><small>Preview QR Code</small></p>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('qrPreview').innerHTML = `
                    <i class="fas fa-qrcode fa-3x text-muted"></i>
                    <p class="text-muted mt-2">Chưa có QR code</p>
                `;
            }
        }
</script>
</body>
</html>