<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="tab-content-wrapper">
    <div class="section-card">
        <div class="section-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-book me-2"></i>Qu·∫£n l√Ω c√¢u chuy·ªán</h5>
            <button class="btn btn-custom btn-sm" onclick="addStory()">
                <i class="fas fa-plus me-2"></i>Th√™m c√¢u chuy·ªán
            </button>
        </div>
        <div class="section-body">
            <!-- Stories List -->
            <div id="storiesList">
                <div class="stories-grid" id="storiesGrid">
                    <!-- Stories will be loaded here -->
                </div>
            </div>
            
            <!-- Story Form -->
            <div id="storyForm" class="story-form-container" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            <span id="storyFormTitle">Th√™m c√¢u chuy·ªán m·ªõi</span>
                        </h6>
                        <button type="button" class="btn-close" onclick="closeStoryForm()"></button>
                    </div>
                    <div class="card-body">
                        <form id="storyFormElement" onsubmit="handleStorySubmit(event)">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">M·ªëc s·ª± ki·ªán</label>
                                        <input type="text" class="form-control" id="storyMilestone" 
                                               placeholder="V√≠ d·ª•: Ng√†y g·∫∑p nhau l·∫ßn ƒë·∫ßu" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ti√™u ƒë·ªÅ</label>
                                        <input type="text" class="form-control" id="storyTitle" 
                                               placeholder="V√≠ d·ª•: üíï L·∫ßn ƒë·∫ßu g·∫∑p m·∫∑t" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label">·∫¢nh minh h·ªça</label>
                                <div class="image-upload-area" onclick="document.getElementById('storyImageInput').click()">
                                    <input type="file" id="storyImageInput" accept="image/*" style="display: none;" onchange="handleStoryImageUpload(event)">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-image fa-3x mb-3"></i>
                                        <p>Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</p>
                                        <small class="text-muted">JPG, PNG, WebP (T·ªëi ƒëa 5MB)</small>
                                    </div>
                                    <img id="storyImagePreview" class="uploaded-image" style="display: none; width: 100%; height: auto; max-height: 250px; object-fit: contain; border-radius: 12px;">
                                    <div id="storyImageActions" style="display: none; margin-top: 10px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeStoryImage()">
                                            <i class="fas fa-trash me-1"></i>X√≥a ·∫£nh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label">N·ªôi dung c√¢u chuy·ªán</label>
                                <textarea class="form-control" id="storyDescription" rows="6" 
                                          placeholder="Vi·∫øt n·ªôi dung c√¢u chuy·ªán c·ªßa b·∫°n..." required></textarea>
                            </div>
                            
                            <div class="form-group mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="storyVisible" checked>
                                    <label class="form-check-label" for="storyVisible">
                                        Hi·ªÉn th·ªã tr√™n website
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeStoryForm()">
                                    <i class="fas fa-times me-2"></i>H·ªßy
                                </button>
                                <button type="submit" class="btn btn-custom">
                                    <i class="fas fa-save me-2"></i>L∆∞u c√¢u chuy·ªán
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Simple and clean story management
let storyData = [];
let editingStory = null;

// Initialize
function initializeStory() {
    console.log('üöÄ Initializing story page');
    console.log('üìä Current storyData:', storyData);
    loadStories();
}

// Load stories from API
async function loadStories() {
    try {
        const response = await fetch('http://localhost:5001/api/data');
        const result = await response.json();
        
        if (result.success && result.data && result.data.story) {
            storyData = result.data.story;
            console.log('üìö Stories loaded:', storyData);
            renderStories();
        } else {
            console.log('üì≠ No stories found');
            storyData = [];
            renderEmptyState();
        }
    } catch (error) {
        console.error('Error loading stories:', error);
        storyData = [];
        renderEmptyState();
    }
}

// Render stories
function renderStories() {
    const grid = document.getElementById('storiesGrid');
    if (!grid) {
        console.error('‚ùå storiesGrid not found');
        return;
    }
    
    console.log('üé® Rendering stories:', storyData.length);
    
    if (storyData.length === 0) {
        renderEmptyState();
        return;
    }
    
    grid.innerHTML = storyData.map((story, index) => `
        <div class="story-card">
            <div class="story-image">
                ${story.src ? `<img src="http://localhost:5001${story.src}" alt="${story.title}">` : '<div class="no-image"><i class="fas fa-image"></i></div>'}
            </div>
            <div class="story-content">
                <h4>${story.title || 'C√¢u chuy·ªán'}</h4>
                <p class="story-milestone">${story.milestone || ''}</p>
                <p class="story-description">${story.description || ''}</p>
            </div>
            <div class="story-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="editStory('${story.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteStory('${story.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
            </div>
        </div>
    `).join('');
}

// Empty state
function renderEmptyState() {
    const grid = document.getElementById('storiesGrid');
    if (!grid) return;
    
    grid.innerHTML = `
        <div class="empty-stories">
            <i class="fas fa-book-open"></i>
            <h5>Ch∆∞a c√≥ c√¢u chuy·ªán n√†o</h5>
            <p>H√£y th√™m c√¢u chuy·ªán ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
            <button class="btn btn-custom mt-3" onclick="addStory()">
                <i class="fas fa-plus me-2"></i>Th√™m c√¢u chuy·ªán ƒë·∫ßu ti√™n
            </button>
        </div>
    `;
}

// Add new story
function addStory() {
    console.log('‚ûï Adding new story');
    
    editingStory = null;
    
    // Reset form
    document.getElementById('storyMilestone').value = '';
    document.getElementById('storyTitle').value = '';
    document.getElementById('storyDescription').value = '';
    document.getElementById('storyVisible').checked = true;
    
    // Reset image
    resetImagePreview();
    
    // Update form title
    document.getElementById('storyFormTitle').textContent = 'Th√™m c√¢u chuy·ªán m·ªõi';
    
    // Show form
    document.getElementById('storyForm').style.display = 'block';
    document.getElementById('storiesList').style.display = 'none';
}

// Edit story
function editStory(storyId) {
    console.log('‚úèÔ∏è Editing story:', storyId);
    
    const story = storyData.find(s => s.id === storyId);
    if (!story) {
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'Kh√¥ng t√¨m th·∫•y c√¢u chuy·ªán!',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    editingStory = story;
    
    // Fill form
    document.getElementById('storyMilestone').value = story.milestone || '';
    document.getElementById('storyTitle').value = story.title || '';
    document.getElementById('storyDescription').value = story.description || '';
    document.getElementById('storyVisible').checked = story.visible !== false;
    
    // Handle image
    if (story.src) {
        showImagePreview(`http://localhost:5001${story.src}`);
    } else {
        resetImagePreview();
    }
    
    // Update form title
    document.getElementById('storyFormTitle').textContent = 'Ch·ªânh s·ª≠a c√¢u chuy·ªán';
    
    // Show form
    document.getElementById('storyForm').style.display = 'block';
    document.getElementById('storiesList').style.display = 'none';
}

// Delete story
async function deleteStory(storyId) {
    const story = storyData.find(s => s.id === storyId);
    if (!story) return;
    
    const result = await Swal.fire({
        title: 'X√°c nh·∫≠n x√≥a',
        text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u chuy·ªán "${story.title}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'X√≥a',
        cancelButtonText: 'H·ªßy'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        storyData = storyData.filter(s => s.id !== storyId);
        await saveStories();
        renderStories();
        Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng!',
            text: 'ƒê√£ x√≥a c√¢u chuy·ªán!',
            confirmButtonText: 'OK'
        });
    } catch (error) {
        console.error('Error deleting story:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'L·ªói khi x√≥a c√¢u chuy·ªán!',
            confirmButtonText: 'OK'
        });
    }
}

// Close form
function closeStoryForm() {
    document.getElementById('storyForm').style.display = 'none';
    document.getElementById('storiesList').style.display = 'block';
    editingStory = null;
    document.getElementById('storyFormElement').reset();
    resetImagePreview();
}

// Handle form submit
async function handleStorySubmit(event) {
    event.preventDefault();
    console.log('üíæ Saving story...');
    
    try {
        const newStoryData = {
            milestone: document.getElementById('storyMilestone').value,
            title: document.getElementById('storyTitle').value,
            description: document.getElementById('storyDescription').value,
            visible: document.getElementById('storyVisible').checked,
            src: getImageSrc(),
            id: editingStory ? editingStory.id : Date.now().toString()
        };
        
        if (!newStoryData.milestone || !newStoryData.title || !newStoryData.description) {
            Swal.fire({
                icon: 'warning',
                title: 'Thi·∫øu th√¥ng tin!',
                text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        if (editingStory) {
            // Update existing
            const index = storyData.findIndex(s => s.id === editingStory.id);
            if (index !== -1) {
                storyData[index] = { ...storyData[index], ...newStoryData };
            }
        } else {
            // Add new
            storyData.push(newStoryData);
        }
        
        await saveStories();
        renderStories();
        closeStoryForm();
        Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng!',
            text: 'ƒê√£ l∆∞u c√¢u chuy·ªán!',
            confirmButtonText: 'OK'
        });
        
    } catch (error) {
        console.error('Error saving story:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: 'L·ªói khi l∆∞u c√¢u chuy·ªán!',
            confirmButtonText: 'OK'
        });
    }
}

// Save to server
async function saveStories() {
    const response = await fetch('http://localhost:5001/api/data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ story: storyData })
    });
    
    if (!response.ok) {
        throw new Error('Failed to save stories');
    }
}

// Image upload
async function handleStoryImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Uploading:', file.name);
    
    // Show loading
    Swal.fire({
        title: 'ƒêang upload...',
        text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', 'story');
    
    try {
        const response = await fetch('http://localhost:5001/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        console.log('Upload result:', result);
        
        if (result.success) {
            const imageUrl = `http://localhost:5001${result.url.replace('./', '/')}`;
            showImagePreview(imageUrl);
            
            // Close loading and show success
            Swal.close();
            Swal.fire({
                icon: 'success',
                title: 'Upload th√†nh c√¥ng!',
                text: '·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.close();
            Swal.fire({
                icon: 'error',
                title: 'L·ªói upload!',
                text: result.message || 'Unknown error',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Upload error:', error);
        Swal.close();
        Swal.fire({
            icon: 'error',
            title: 'L·ªói upload!',
            text: error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Remove image
function removeStoryImage() {
    console.log('Removing story image...');
    resetImagePreview();
}

// Helper functions
function showImagePreview(imageUrl) {
    const preview = document.getElementById('storyImagePreview');
    const placeholder = document.querySelector('.upload-placeholder');
    const actions = document.getElementById('storyImageActions');
    
    preview.src = imageUrl;
    preview.style.display = 'block';
    placeholder.style.display = 'none';
    actions.style.display = 'block';
}

function resetImagePreview() {
    const preview = document.getElementById('storyImagePreview');
    const placeholder = document.querySelector('.upload-placeholder');
    const actions = document.getElementById('storyImageActions');
    const fileInput = document.getElementById('storyImageInput');
    
    preview.style.display = 'none';
    preview.src = '';
    placeholder.style.display = 'flex';
    actions.style.display = 'none';
    fileInput.value = '';
}

function getImageSrc() {
    const preview = document.getElementById('storyImagePreview');
    if (preview && preview.src && preview.style.display !== 'none') {
        let src = preview.src;
        if (src.includes('http://localhost:5001')) {
            src = src.replace('http://localhost:5001', '');
        }
        return src;
    }
    return '';
}

// Export functions
window.initializeStory = initializeStory;
window.addStory = addStory;
window.editStory = editStory;
window.deleteStory = deleteStory;
window.closeStoryForm = closeStoryForm;
window.handleStorySubmit = handleStorySubmit;
window.handleStoryImageUpload = handleStoryImageUpload;
window.removeStoryImage = removeStoryImage;

// Debug function
window.debugStories = function() {
    console.log('üîç Debug Stories:');
    console.log('üìä storyData:', storyData);
    console.log('üéØ storiesGrid element:', document.getElementById('storiesGrid'));
    console.log('üìö Current stories count:', storyData.length);
    loadStories();
};

// Force load stories function
window.forceLoadStories = function() {
    console.log('üîÑ Force loading stories...');
    loadStories();
};

// Auto-initialize
document.addEventListener('DOMContentLoaded', initializeStory);

// Also try to initialize immediately if DOM is already ready
if (document.readyState === 'loading') {
    console.log('üìö DOM still loading, waiting for DOMContentLoaded');
} else {
    console.log('üìö DOM already ready, initializing immediately');
    setTimeout(initializeStory, 100);
}
</script>

<style>
/* Simple and clean styles */
.stories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.story-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.story-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.story-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.story-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-image {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    background: #f8f9fa;
    color: #6c757d;
    font-size: 3rem;
}

.story-content {
    padding: 20px;
}

.story-content h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
}

.story-milestone {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #9f5958;
    font-weight: 500;
}

.story-description {
    margin: 0;
    font-size: 14px;
    color: #6c757d;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.story-actions {
    padding: 15px 20px;
    background: #f8f9fa;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.story-actions .btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
}

.empty-stories {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-stories i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #dee2e6;
}

.empty-stories h5 {
    margin-bottom: 10px;
    color: #495057;
}

.empty-stories p {
    margin-bottom: 20px;
}

.story-form-container {
    margin-top: 20px;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
    margin-top: 20px;
}

.image-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.image-upload-area:hover {
    border-color: #9f5958;
    background: #fff5f5;
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #6c757d;
}

.uploaded-image {
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .stories-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .story-content {
        padding: 15px;
    }
    
    .story-actions {
        padding: 10px 15px;
        flex-direction: column;
    }
    
    .story-actions .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
        margin-bottom: 10px;
    }
}
</style>