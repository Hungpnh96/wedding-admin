<div class="tab-content-wrapper">
    <div class="row">
        <div class="col-md-8">
            <!-- Dashboard Statistics -->
            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Th·ªëng k√™ Dashboard</h5>
                </div>
                <div class="section-body">
                    <div class="row g-3">
                        <!-- Total Images -->
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card text-center p-3 border rounded">
                                <div class="h3 text-primary mb-1" id="totalImages">0</div>
                                <div class="text-muted small">T·ªïng ·∫£nh</div>
                                <div class="text-muted" style="font-size: 0.75rem;" id="imageBreakdown">
                                    <span id="bannerImages">0</span> banner, 
                                    <span id="galleryImages">0</span> gallery, 
                                    <span id="storyImages">0</span> story
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stories -->
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card text-center p-3 border rounded">
                                <div class="h3 text-success mb-1" id="totalStories">0</div>
                                <div class="text-muted small">C√¢u chuy·ªán</div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    <span id="visibleStories">0</span> hi·ªÉn th·ªã
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gallery -->
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card text-center p-3 border rounded">
                                <div class="h3 text-warning mb-1" id="totalGallery">0</div>
                                <div class="text-muted small">Th∆∞ vi·ªán ·∫£nh</div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    <span id="visibleGallery">0</span> hi·ªÉn th·ªã
                                </div>
                            </div>
                        </div>
                        
                        <!-- Blessings -->
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card text-center p-3 border rounded">
                                <div class="h3 text-info mb-1" id="totalBlessings">-</div>
                                <div class="text-muted small">L·ªùi ch√∫c</div>
                                <div class="text-muted" style="font-size: 0.75rem;" id="blessingBreakdown">
                                    <span id="approvedBlessings">-</span> ƒë√£ duy·ªát, 
                                    <span id="pendingBlessings">-</span> ch·ªù duy·ªát
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Status -->
            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-eye me-2"></i>Tr·∫°ng th√°i c√°c ph·∫ßn</h5>
                </div>
                <div class="section-body">
                    <div class="row g-2" id="sectionStatusList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Recent Blessings -->
            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-heart me-2"></i>L·ªùi ch√∫c m·ªõi nh·∫•t</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshBlessingsPreview()" id="refreshBlessingsBtn">
                        <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                    </button>
                </div>
                <div class="section-body">
                    <div id="recentBlessingsList">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-bolt me-2"></i>Thao t√°c nhanh</h5>
                </div>
                <div class="section-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-custom" onclick="previewWebsite()">
                            <i class="fas fa-external-link-alt me-2"></i>Xem tr∆∞·ªõc website
                        </button>
                        <button class="btn btn-outline-success" onclick="saveSiteData()">
                            <i class="fas fa-save me-2"></i>L∆∞u t·∫•t c·∫£ thay ƒë·ªïi
                        </button>
                        <button class="btn btn-outline-primary" onclick="goToTab('blessings')">
                            <i class="fas fa-heart me-2"></i>Qu·∫£n l√Ω l·ªùi ch√∫c
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-save me-2"></i>L∆∞u tr·ªØ & Xu·∫•t</h5>
                </div>
                <div class="section-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="saveSiteData()">
                            <i class="fas fa-save me-2"></i>L∆∞u thay ƒë·ªïi
                        </button>
                        <button class="btn btn-outline-primary" onclick="downloadData()">
                            <i class="fas fa-download me-2"></i>T·∫£i file JSON
                        </button>
                        <button class="btn btn-outline-secondary" onclick="loadData()">
                            <i class="fas fa-upload me-2"></i>Nh·∫≠p file JSON
                        </button>
                        <button class="btn btn-outline-info" onclick="exportUploadedFiles()">
                            <i class="fas fa-file-export me-2"></i>Xu·∫•t file ·∫£nh
                        </button>
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload(this)">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h5><i class="fas fa-info-circle me-2"></i>H∆∞·ªõng d·∫´n nhanh</h5>
                </div>
                <div class="section-body">
                    <div class="alert alert-info">
                        <small>
                            <strong>üí° M·∫πo:</strong><br>
                            ‚Ä¢ K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp n·ªôi dung<br>
                            ‚Ä¢ Click v√†o ·∫£nh ƒë·ªÉ thay ƒë·ªïi<br>
                            ‚Ä¢ S·ª≠ d·ª•ng n√∫t "Xem tr∆∞·ªõc" ƒë·ªÉ ki·ªÉm tra<br>
                            ‚Ä¢ Nh·ªõ l∆∞u thay ƒë·ªïi tr∆∞·ªõc khi ƒë√≥ng
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    background: #fff;
    transition: all 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.section-status-item {
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.section-status-item.active {
    background-color: #d4edda;
    border-left: 3px solid #28a745;
}
.section-status-item.inactive {
    background-color: #f8d7da;
    border-left: 3px solid #dc3545;
}
.blessing-item {
    padding: 0.75rem;
    border-left: 3px solid #007bff;
    background: #f8f9fa;
    margin-bottom: 0.5rem;
    border-radius: 4px;
}
.blessing-item .blessing-name {
    font-weight: 600;
    color: #495057;
}
.blessing-item .blessing-content {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.25rem;
}
.blessing-item .blessing-time {
    font-size: 0.75rem;
    color: #adb5bd;
    margin-top: 0.25rem;
}
</style>

<script>
// Overview Tab JavaScript
function initializeOverview() {
    console.log('üìä Initializing overview tab');
    
    // Wait for siteData to be available
    if (!window.siteData || Object.keys(window.siteData).length === 0) {
        console.log('‚è≥ Waiting for siteData to load...');
        // Retry after a short delay
        setTimeout(() => {
            if (window.siteData && Object.keys(window.siteData).length > 0) {
                initializeOverview();
            } else {
                console.warn('‚ö†Ô∏è siteData still not available, loading with default');
                loadOverviewStats();
            }
        }, 500);
        return;
    }
    
    // Load overview statistics
    loadOverviewStats();
    
    // Load blessings statistics
    loadBlessingsStats();
    
    // Load section status
    loadSectionStatus();
    
    // Load recent blessings
    loadRecentBlessings();
    
    // Setup event listeners
    setupOverviewEventListeners();
}

function loadOverviewStats() {
    console.log('üìä Loading overview statistics...');
    console.log('üìä Current siteData:', window.siteData);
    
    // Update statistics from siteData
    if (!window.siteData || Object.keys(window.siteData).length === 0) {
        console.warn('‚ö†Ô∏è No siteData available, using defaults');
        // Show default values
        updateElement('totalImages', 0);
        updateElement('bannerImages', 0);
        updateElement('galleryImages', 0);
        updateElement('storyImages', 0);
        updateElement('totalStories', 0);
        updateElement('visibleStories', 0);
        updateElement('totalGallery', 0);
        updateElement('visibleGallery', 0);
        return;
    }
    
    // Calculate image statistics
    const bannerImages = window.siteData.hero?.slides?.length || 0;
    const galleryImages = window.siteData.gallery?.length || 0;
    const storyImages = window.siteData.story?.length || 0;
    const totalImages = bannerImages + galleryImages + storyImages;
    
    console.log('üìä Image breakdown:', {
        bannerImages,
        galleryImages,
        storyImages,
        totalImages
    });
    
    // Stories
    const totalStories = window.siteData.story?.length || 0;
    const visibleStories = window.siteData.story?.filter(s => s.visible !== false).length || 0;
    
    console.log('üìä Stories:', {
        totalStories,
        visibleStories,
        storyArray: window.siteData.story
    });
    
    // Gallery
    const totalGallery = window.siteData.gallery?.length || 0;
    const visibleGallery = window.siteData.gallery?.filter(g => g.visible !== false).length || 0;
    
    console.log('üìä Gallery:', {
        totalGallery,
        visibleGallery,
        galleryArray: window.siteData.gallery
    });
    
    // Update DOM
    updateElement('totalImages', totalImages);
    updateElement('bannerImages', bannerImages);
    updateElement('galleryImages', galleryImages);
    updateElement('storyImages', storyImages);
    
    updateElement('totalStories', totalStories);
    updateElement('visibleStories', visibleStories);
    
    updateElement('totalGallery', totalGallery);
    updateElement('visibleGallery', visibleGallery);
    
    console.log('‚úÖ Overview statistics loaded');
}

async function loadBlessingsStats() {
    console.log('üíå Loading blessings statistics...');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${window.location.origin}/api/blessing/admin/stats`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data || {};
            updateElement('totalBlessings', stats.total || 0);
            updateElement('approvedBlessings', stats.approved || 0);
            updateElement('pendingBlessings', stats.pending || 0);
            console.log('‚úÖ Blessings statistics loaded:', stats);
        } else {
            console.warn('‚ö†Ô∏è Failed to load blessings stats:', data.message);
            updateElement('totalBlessings', '0');
            updateElement('approvedBlessings', '0');
            updateElement('pendingBlessings', '0');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            console.error('‚ùå Timeout loading blessings stats');
        } else {
            console.error('‚ùå Error loading blessings stats:', error);
        }
        // Show 0 instead of ? if API fails
        updateElement('totalBlessings', '0');
        updateElement('approvedBlessings', '0');
        updateElement('pendingBlessings', '0');
    }
}

function loadSectionStatus() {
    console.log('üëÅÔ∏è Loading section status...');
    
    if (!window.siteData?.visibility?.sections) {
        return;
    }
    
    const sections = {
        'hero': { name: 'Banner ch√≠nh', icon: 'fa-image' },
        'couple': { name: 'C·∫∑p ƒë√¥i', icon: 'fa-heart' },
        'story': { name: 'C√¢u chuy·ªán', icon: 'fa-book' },
        'gallery': { name: 'Th∆∞ vi·ªán ·∫£nh', icon: 'fa-images' },
        'rsvp': { name: 'L·ªùi ch√∫c', icon: 'fa-comment-dots' },
        'donate': { name: 'Qu√† c∆∞·ªõi', icon: 'fa-gift' },
        'event': { name: 'S·ª± ki·ªán', icon: 'fa-calendar' },
        'audio': { name: 'Nh·∫°c n·ªÅn', icon: 'fa-music' }
    };
    
    const statusListEl = document.getElementById('sectionStatusList');
    if (!statusListEl) return;
    
    let html = '';
    for (const [key, section] of Object.entries(sections)) {
        const isVisible = window.siteData.visibility?.sections[key] !== false;
        html += `
            <div class="col-md-6 col-sm-12">
                <div class="section-status-item ${isVisible ? 'active' : 'inactive'}">
                    <span>
                        <i class="fas ${section.icon} me-2"></i>
                        ${section.name}
                    </span>
                    <span class="badge ${isVisible ? 'bg-success' : 'bg-danger'}">
                        ${isVisible ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                    </span>
                </div>
            </div>
        `;
    }
    
    statusListEl.innerHTML = html;
    console.log('‚úÖ Section status loaded');
}

async function loadRecentBlessings() {
    console.log('üíå Loading recent blessings...');
    
    const listEl = document.getElementById('recentBlessingsList');
    if (!listEl) return;
    
    listEl.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';
    
    try {
        const response = await fetch(`${window.location.origin}/api/blessing/latest?limit=5`);
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            let html = '';
            data.data.forEach(blessing => {
                const date = new Date(blessing.created_at);
                const timeStr = date.toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="blessing-item">
                        <div class="blessing-name">${escapeHtml(blessing.name)}</div>
                        <div class="blessing-content">${escapeHtml(blessing.content)}</div>
                        <div class="blessing-time">${timeStr} ${blessing.approved ? '<span class="badge bg-success">ƒê√£ duy·ªát</span>' : '<span class="badge bg-warning">Ch·ªù duy·ªát</span>'}</div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
            console.log('‚úÖ Recent blessings loaded');
        } else {
            listEl.innerHTML = '<div class="text-center text-muted py-3">Ch∆∞a c√≥ l·ªùi ch√∫c n√†o</div>';
        }
    } catch (error) {
        console.error('‚ùå Error loading recent blessings:', error);
        listEl.innerHTML = '<div class="text-center text-danger py-3">Kh√¥ng th·ªÉ t·∫£i l·ªùi ch√∫c</div>';
    }
}

function refreshBlessingsPreview() {
    const btn = document.getElementById('refreshBlessingsBtn');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
    }
    
    loadBlessingsStats();
    loadRecentBlessings();
    
    setTimeout(() => {
        if (btn) {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> L√†m m·ªõi';
            btn.disabled = false;
        }
    }, 1000);
}

function goToTab(tabName) {
    const tabButton = document.querySelector(`[data-bs-target="#${tabName}"]`);
    if (tabButton) {
        tabButton.click();
    }
}

function updateElement(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function setupOverviewEventListeners() {
    // Preview website button
    const previewBtn = document.querySelector('[onclick*="previewWebsite"]');
    if (previewBtn) {
        previewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof previewWebsite === 'function') {
                previewWebsite();
            }
        });
    }
    
    // Save changes button
    const saveBtn = document.querySelector('[onclick*="saveSiteData"]');
    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof saveSiteData === 'function') {
                saveSiteData();
            }
        });
    }
    
    // Download data button
    const downloadBtn = document.querySelector('[onclick*="downloadData"]');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof downloadData === 'function') {
                downloadData();
            }
        });
    }
    
    // Load data button
    const loadBtn = document.querySelector('[onclick*="loadData"]');
    if (loadBtn) {
        loadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof loadData === 'function') {
                loadData();
            }
        });
    }
    
    // Export files button
    const exportBtn = document.querySelector('[onclick*="exportUploadedFiles"]');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof exportUploadedFiles === 'function') {
                exportUploadedFiles();
            }
        });
    }
}

// Export functions for global access
window.initializeOverview = initializeOverview;
window.loadOverviewStats = loadOverviewStats;
window.loadBlessingsStats = loadBlessingsStats;
window.loadSectionStatus = loadSectionStatus;
window.loadRecentBlessings = loadRecentBlessings;

// Listen for siteData updates
document.addEventListener('siteDataUpdated', function() {
    console.log('üìä siteData updated event received, refreshing overview...');
    if (typeof window.initializeOverview === 'function') {
        setTimeout(() => {
            window.initializeOverview();
        }, 300);
    }
});

// Also listen for custom event when data is loaded
window.addEventListener('siteDataLoaded', function() {
    console.log('üìä siteData loaded event received, refreshing overview...');
    if (typeof window.initializeOverview === 'function') {
        setTimeout(() => {
            window.initializeOverview();
        }, 300);
    }
});
</script>
